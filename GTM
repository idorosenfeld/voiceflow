<script>
  // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×©×™×©××•×¨ ××ª ×”××–×”×” ×©×œ ×”×¤× ×™×™×” ×”××—×¨×•× ×” ×©×¢×™×‘×“× ×•
  let lastProcessedUserTurnId = null;

  window.addEventListener('message', (e) => {
    const data = e.data;

    // ×•×“× ×©×–×” ××—×¨×•×–×ª ×˜×§×¡×˜
    if (typeof data === 'string') {
      try {
        const parsed = JSON.parse(data);

        // × ×ª××§×“ ×¨×§ ×‘××™×¨×•×¢×™× ×©××›×™×œ×™× ×”×™×¡×˜×•×¨×™×™×ª ×¤× ×™×•×ª ('turns')
        if (parsed && parsed.payload && Array.isArray(parsed.payload.turns)) {
          const turns = parsed.payload.turns;
          const userTurns = turns.filter(turn => turn.type === "user");

          if (userTurns.length > 0) {
            const lastUserTurn = userTurns[userTurns.length - 1];
            const userMessage = lastUserTurn?.message || "";
            const currentTurnId = lastUserTurn?.id;

            // ×‘×“×™×§×” ×œ×× ×™×¢×ª ×¢×™×‘×•×“ ×›×¤×•×œ
            if (currentTurnId && currentTurnId === lastProcessedUserTurnId) {
              console.log(`×›×‘×¨ ×¢×™×‘×“× ×• ××ª ×¤× ×™×™×” ${currentTurnId}, ××ª×¢×œ××™× ××”×•×“×¢×” ×–×•.`);
              return;
            }

            if (userMessage && currentTurnId) {
              console.log(`××¢×‘×“ ×¤× ×™×™×” ×—×“×©×”: ${currentTurnId}. ×”×•×“×¢×”:`, userMessage);
              let eventWasPushed = false;

              // ×‘×“×™×§×” ×¢×‘×•×¨ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
              const phoneRegex = /\b05\d{8}\b/;
              const phoneMatch = userMessage.match(phoneRegex);
              if (phoneMatch) {
                const phoneNumber = phoneMatch[0];
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                  event: 'lead_generated',
                  phone: phoneNumber,
                  eventCategory: 'Chat',
                  eventAction: 'User Sent Phone',
                  eventLabel: 'chatbot_user_phone',
                  clickClasses: 'chatbot-lead' // âœ… × ×™×ª×Ÿ ×œ×©× ×•×ª ×œ×¤×™ ×”×¦×•×¨×š
                });
                console.log(`ğŸ“¤ lead_generated × ×©×œ×— ×œ-dataLayer (×¤× ×™×™×” ${currentTurnId})`);
                eventWasPushed = true;
              }

              // ×‘×“×™×§×” ×¢×‘×•×¨ ×”×•×“×¢×ª ×§×™×©×•×¨ ×œ×•×•××˜×¡××¤
              const whatsappPhrase = "×œ×©×™×—×” ×‘×•×•×˜×¡××¤ ×¢× × ×¦×™×’ ××§×¦×•×¢×™";
              const cleanUserMessage = userMessage.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}]/gu, '').trim();
              if (cleanUserMessage.includes(whatsappPhrase)) {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                  event: 'linked_to_whatsapp',
                  eventCategory: 'Chat',
                  eventAction: 'User Clicked WhatsApp',
                  eventLabel: 'chatbot_whatsapp_link',
                  clickClasses: 'chatbot-whatsapp' // âœ… × ×™×ª×Ÿ ×œ×©× ×•×ª ×œ×¤×™ ×”×¦×•×¨×š
                });
                console.log(`ğŸ“¤ linked_to_whatsapp × ×©×œ×— ×œ-dataLayer (×¤× ×™×™×” ${currentTurnId})`);
                eventWasPushed = true;
              }

              // ×¢×“×›×•×Ÿ ××–×”×” ××—×¨×•×Ÿ ×¨×§ ×× × ×©×œ×— ××™×¨×•×¢
              if (eventWasPushed) {
                lastProcessedUserTurnId = currentTurnId;
                console.log(`×¢×“×›×•×Ÿ ×”××–×”×” ×”××—×¨×•×Ÿ ×©×¢×•×‘×“: ${lastProcessedUserTurnId}`);
              } else {
                console.log(`×œ× × ×©×œ×— ××™×¨×•×¢ DataLayer ×¢×‘×•×¨ ×¤× ×™×™×” ${currentTurnId}, ×œ× ××¢×“×›× ×™× ID.`);
              }
            }
          }
        }
      } catch (err) {
        // ×©×’×™××” ×‘×¤×¢× ×•×— JSON ××• ×‘×¢×™×‘×•×“
        // console.warn("×©×’×™××” ×‘×¢×™×‘×•×“ ×”×•×“×¢×”:", err, data);
      }
    }
  });
</script>
